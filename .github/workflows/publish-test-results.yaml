name: "Test result summary"
on:
  workflow_call:
    inputs:
      runs-on:
        description: "The type of machine to run the job on e.g macOS-latest or ubuntu-latest"
        required: true
        type: string      
      junit-results-glob-pattern:
        description: "Glob expression to junit report paths"
        required: true
        type: string
      check-name:
        description: "Check run name"
        required: true
        type: string
      slack-notification:
        description: "Enable slack push notification for test results"
        default: false
        required: false
        type: boolean 
    secrets:
      SLACK_BOT_TOKEN:
        description: "Slack bot secret for push notification"
        required: false
env:
  TEST_RESULTS_PATH: "/tmp/test-results"
jobs:
  tests:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Download test artifacts
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
        with:
          path: ${{ env.TEST_RESULTS_PATH }}
      - name: Publish Test Report      
        id: test-report
        uses: mikepenz/action-junit-report@v3.5.2
        if: always()
        with:
          report_paths: ${{ env.TEST_RESULTS_PATH }}/**/${{ inputs.junit-results-glob-pattern }}
          check_name: ${{ inputs.check-name }}
      - name: Notify slack of test results
        if: ${{ (inputs.slack-notification) && (github.event_name != 'workflow_dispatch') }}
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: C03FDNVE7RC
          slack-message: "*${{inputs.check-name}}*\n>Tests :test_tube:\t\t\tPassed :check:\t\t\tSkipped :arrow_right_hook:\t\t\tFailed :x:\n>${{steps.test-report.outputs.total}} runs\t\t\t ${{steps.test-report.outputs.passed}} passed\t\t\t ${{steps.test-report.outputs.skipped}} skipped\t\t\t  ${{steps.test-report.outputs.failed}} failed"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
