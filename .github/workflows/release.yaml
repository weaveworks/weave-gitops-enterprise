on:
  push:
    tags: [v*.*.*]

name: release
jobs:
  build:
    uses: ./.github/workflows/build.yaml
    with:
      helmrepo: "releases/charts-v3"
    secrets:
      BUILD_BOT_PERSONAL_ACCESS_TOKEN: ${{ secrets.BUILD_BOT_PERSONAL_ACCESS_TOKEN }}
      WGE_DOCKER_IO_USER: ${{ secrets.WGE_DOCKER_IO_USER }}
      WGE_DOCKER_IO_PASSWORD: ${{ secrets.WGE_DOCKER_IO_PASSWORD }}
      WGE_NPM_GITHUB_TOKEN: ${{ secrets.WGE_NPM_GITHUB_TOKEN }}
      WGE_S3_AWS_ACCESS_KEY_ID: ${{ secrets.WGE_S3_AWS_ACCESS_KEY_ID }}
      WGE_S3_AWS_SECRET_ACCESS_KEY: ${{ secrets.WGE_S3_AWS_SECRET_ACCESS_KEY }}

  releaser:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v2
      with:
        configuration: "${{ github.workspace }}/.github/workflows/changelog_configuration.json"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        prerelease: true
        body: ${{steps.github_release.outputs.changelog}}

  goreleaser:
    runs-on: ubuntu-latest
    needs: releaser
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Setup Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.18.X
    - name: Set env var
      run: |
        echo "LDFLAGS=$(make echo-ldflags)" >> $GITHUB_ENV
        echo "GORELEASER_PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))" >> $GITHUB_ENV
        echo "GORELEASER_CURRENT_TAG=$(git describe --abbrev=0 --tags)" >> $GITHUB_ENV

    - name: "Make All"
      run: make all
    - name: Check Git State
      run: git diff --no-ext-diff --exit-code
    #- name: Run GoReleaser
    #  uses: goreleaser/goreleaser-action@v1
    #  with:
    #    version: latest
    #    args: release --rm-dist
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.WEAVE_GITOPS_BOT_ACCESS_TOKEN }}
