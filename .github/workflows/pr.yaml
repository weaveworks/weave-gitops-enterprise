name: create pr

on:
  push:
  workflow_dispatch:

# Manual or scheduled trigger every 1 hour
# schedule:
#  - cron: '0 * * * *'

jobs:
  enterprise-pr:
    name: update oss pr
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Setup Go
        uses: actions/setup-go@v4.0.0
        with:
          go-version: 1.20.x
      - name: Check out enterprise
        uses: actions/checkout@v2
        with:
          repository: "weaveworks/weave-gitops-enterprise"
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0
      - name: Find current revision
        id: current-rev
        run: |
          current_revision=$(grep 'weave-gitops ' go.mod | cut -d' ' -f2 | cut -d'-' -f3)
          echo "::set-output name=revision::$current_revision"
      - name: Fetch latest tag from weave-gitops
        id: fetch-latest-tag
        run: |
          latest_tag=$(git ls-remote --tags https://github.com/weaveworks/weave-gitops.git | awk -F/ '$NF ~ /^v[0-9]+\.[0-9]+\.[0-9]+$/ {print $NF}' | sort -V | tail -n1)
          echo "::set-output name=tag::$latest_tag"
      - name: Configure git for private modules
        env:
          GITHUB_BUILD_USERNAME: wge-build-bot
          GITHUB_BUILD_TOKEN: ${{ secrets.BUILD_BOT_PERSONAL_ACCESS_TOKEN }}
        run: git config --global url."https://${GITHUB_BUILD_USERNAME}:${GITHUB_BUILD_TOKEN}@github.com".insteadOf "https://github.com"
      - name: Upgrade main version
        run: |
          set -x
          latest_tag=${{ steps.fetch-latest-tag.outputs.tag }}
          echo "Latest tag is $latest_tag" > test-pr.txt
          export GOPRIVATE=github.com/weaveworks
          go get -u github.com/weaveworks/weave-gitops@$latest_tag
          go mod tidy
          cd ui-cra
          yarn add @weaveworks/weave-gitops@$latest_tag
          # This is a convience to help auto-update snapshots if core components have changed.
          # However it can still fail if larger changes have been made, breaking the PR creation.
          # In this case we still want to continue w/ PR creation and fixes can be made in the EE PR manually.
          # So we do a `|| true` to continue this workflow even on failure.
          yarn test -u || true
        env:
          GITHUB_TOKEN: ${{ secrets.BUILD_BOT_PERSONAL_ACCESS_TOKEN}}
      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          author: wge-build-bot <wge-build-bot@weave.works>
          signoff: true
          committer: wge-build-bot <wge-build-bot@weave.works>
          branch: track-latest-oss
          base: main
          title: "Bump weave-gitops to latest ${{ steps.fetch-latest-tag.outputs.tag }}"
          body: |
            Update weave-gitops to latest release ${{ steps.fetch-latest-tag.outputs.tag }}
          # Uncomment this when you want to involve the author:
          #
          #            cc @${{ github.event.sender.login }}
          commit-message: "Bump version of weave-gitops to latest"
          token: ${{ secrets.BUILD_BOT_PERSONAL_ACCESS_TOKEN }}
          delete-branch: true
          labels: "exclude from release notes"
