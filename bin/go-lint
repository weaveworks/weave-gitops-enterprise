#!/bin/bash

set -e

GOPATH=$(go env GOPATH)
if [ ! -x "${GOPATH}/bin/golangci-lint" ]; then
    curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "${GOPATH}/bin" v1.41.1
fi

#
# FIXME: build-tags=dev is a workaround to lint the dev golang files until we
# figure out how to lint the prod ones. At the moment the prod files cause OOM
# errors as they include large vfs.
# https://github.com/weaveworks/wks/issues/1071
#
export GOGC=10
"${GOPATH}/bin/golangci-lint" run --tests --deadline=600s \
    --disable=errcheck \
    --enable=misspell \
    --verbose \
    --build-tags=dev \
    --enable=gofmt \
    --skip-dirs=pkg/guide \
    --skip-dirs=pkg/addons/assets \
    --timeout=15m \
    ./...
